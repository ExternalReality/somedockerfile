version: v1.0
name: Run Data Integrity Check
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Get Dynamic Credentials
    dependencies: []
    task:
      jobs:
        - name: Request
          commands:
            - 'curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -'
            - 'sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"'
            - sudo apt-get update && sudo apt-get install vault -y
            - vault login $VAULT_TOKEN
            - vault read database/creds/postgres
      secrets:
        - name: vault token
      env_vars:
        - name: VAULT_ADDR
          value: 'http://ec2-user@ec2-3-215-198-153.compute-1.amazonaws.com:8200'
  - name: Run Data Itegerity Check
    dependencies:
      - Get Dynamic Credentials
    task:
      secrets:
        - name: vault token
      jobs:
        - name: Run Integrity Check
          commands:
            - 'curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -'
            - 'sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"'
            - sudo apt-get update && sudo apt-get install vault -y
            - vault login $VAULT_TOKEN
            - vault read database/creds/postgres > creds-file
  - name: Cleanup
    dependencies:
      - Run Data Itegerity Check
    task:
      env_vars:
        - name: VAULT_ADDR
          value: 'http://ec2-user@ec2-3-215-198-153.compute-1.amazonaws.com:8200'
      jobs:
        - name: Revoke
          commands:
            - 'curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -'
            - 'sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"'
            - sudo apt-get update && sudo apt-get install vault -y
            - vault login $VAULT_TOKEN
      secrets:
        - name: vault token
